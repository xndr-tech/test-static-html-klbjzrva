name: QA Check

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'URL to check (leave empty for auto-detect)'
        required: false
        type: string
  workflow_call:
    inputs:
      url:
        required: false
        type: string

jobs:
  qa:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Determine URL
        id: url
        run: |
          if [ -n "${{ inputs.url }}" ]; then
            echo "url=${{ inputs.url }}" >> $GITHUB_OUTPUT
          else
            echo "url=https://test-static-html-klbjzrva.workers.dev" >> $GITHUB_OUTPUT
          fi
      
      - name: Check Site
        run: |
          URL="${{ steps.url.outputs.url }}"
          echo "Checking: $URL"
          
          HTTP_CODE=$(curl -s -o /tmp/page.html -w "%{http_code}" "$URL" --max-time 30)
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::Site returned HTTP $HTTP_CODE"
            exit 1
          fi
          
          echo "✅ Site accessible (HTTP $HTTP_CODE)"
          
          CONTENT_LENGTH=$(wc -c < /tmp/page.html)
          if [ "$CONTENT_LENGTH" -lt 1000 ]; then
            echo "::error::Content too short ($CONTENT_LENGTH bytes)"
            exit 1
          fi
          
          if ! grep -q '</html>' /tmp/page.html; then
            echo "::error::HTML appears truncated"
            exit 1
          fi
          
          echo "### QA Results ✅" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Site Accessible | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Content Length | $CONTENT_LENGTH bytes |" >> $GITHUB_STEP_SUMMARY
          echo "| HTML Complete | ✅ |" >> $GITHUB_STEP_SUMMARY
